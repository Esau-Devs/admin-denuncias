---
import "../styles/global.css";
import { ClientRouter } from "astro:transitions";
---

<!doctype html>
<html lang="es" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/escudo.svg" />
    <meta name="generator" content={Astro.generator} />
    <title>Administrar Denuncias | Plataforma segura</title>
    <ClientRouter fallback="none" />
  </head>
  <body>
    <slot />
  </body>
</html>

<!-- ðŸ”‘ SCRIPT: Sincronizar token del backend -->
<script>
  import { supabase } from "../lib/supabaseClient.js";

  // FunciÃ³n para obtener token del backend
  const syncTokenFromBackend = async () => {
    const {
      data: { session },
    } = await supabase.auth.getSession();

    if (session?.user?.id) {
      try {
        const formData = new FormData();
        formData.append("user_id", session.user.id);

        const response = await fetch(
          "https://backend-api-638220759621.us-west1.run.app/token/verify-supabase",
          {
            method: "POST",
            credentials: "include",
            body: formData,
          },
        );

        if (response.ok) {
          const data = await response.json();
          if (data.access_token) {
            localStorage.setItem("token", data.access_token);
            console.log("âœ… Token del backend sincronizado");
          }
        }
      } catch (err) {
        console.error("âŒ Error sincronizando token:", err);
      }
    } else {
      // No hay sesiÃ³n, limpiar token
      localStorage.removeItem("token");
    }
  };

  // Ejecutar al cargar
  syncTokenFromBackend();

  // Escuchar cambios de autenticaciÃ³n
  supabase.auth.onAuthStateChange((event, session) => {
    console.log("ðŸ”„ Auth event:", event);

    if (event === "SIGNED_IN" || event === "TOKEN_REFRESHED") {
      syncTokenFromBackend();
    }

    if (event === "SIGNED_OUT") {
      localStorage.removeItem("token");
      console.log("ðŸšª Token eliminado");
    }
  });
</script>

<style is:global>
  html {
    background: #f5f7f7;
    font-family: "Montserrat", sans-serif;
  }
  html,
  body {
    margin: 0;
    width: 100%;
    height: 100%;
    line-height: 1.6;
  }
  @font-face {
    font-family: "Montserrat";
    src: url(/fonts/Montserrat-Regular.ttf) format("truetype");
    font-weight: 400;
    font-display: swap;
    font-style: normal;
  }
  @font-face {
    font-family: "Montserrat";
    src: url(/fonts/Montserrat-Medium.ttf) format("truetype");
    font-weight: 500;
    font-display: swap;
    font-style: normal;
  }
  @font-face {
    font-family: "Montserrat";
    src: url(/fonts/Montserrat-SemiBold.ttf) format("truetype");
    font-weight: 600;
    font-display: swap;
    font-style: normal;
  }
  @font-face {
    font-family: "Montserrat";
    src: url(/fonts/Montserrat-Bold.ttf) format("truetype");
    font-weight: 700;
    font-display: swap;
    font-style: normal;
  }
</style>
