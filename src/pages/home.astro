---
import FiltrarDenuncia from "../components/organisms/FiltrarDenuncia.jsx";
import Layout from "../layouts/Layout.astro";
import Header from "../components/atoms/Header.astro";

let TotalDenuncias = 0;
let Pendiente = 0;
let Enproceso = 0;
let resuelta = 0;
let no_corresponde = 0;
---

<Layout title="Inicio de denuncias">
    <!-- Loader mientras verifica autenticación -->
    <div
        id="auth-loading"
        class="fixed inset-0 bg-white z-50 flex items-center justify-center"
    >
        <div class="text-center">
            <div
                class="w-12 h-12 border-4 border-blue-200 border-t-[#0c3b87] rounded-full animate-spin mx-auto"
            >
            </div>
            <p class="mt-4 text-gray-600">Verificando sesión...</p>
        </div>
    </div>

    <!-- Contenido protegido (oculto hasta verificar) -->
    <div id="protected-content" class="hidden">
        <Header />
        <main class="bg-[#f5f7f7] min-h-screen m-5">
            <div class="container mx-auto">
                <section
                    class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-6 my-10"
                >
                    <article
                        class="bg-white border border-gray-300 p-6 rounded-2xl shadow-sm text-center hover:shadow-md transition-shadow"
                    >
                        <span
                            id="total-denuncias"
                            class="text-4xl font-semibold text-black"
                        >
                            {TotalDenuncias}
                        </span>
                        <p class="text-sm text-gray-600 mt-2">
                            Total de denuncias
                        </p>
                    </article>

                    <article
                        class="bg-white border border-gray-300 p-6 rounded-2xl shadow-sm text-center hover:shadow-md transition-shadow"
                    >
                        <span
                            id="pendiente-denuncias"
                            class="text-4xl font-semibold text-black"
                        >
                            {Pendiente}
                        </span>
                        <p class="text-sm text-gray-600 mt-2">
                            Denuncias pendientes
                        </p>
                    </article>

                    <article
                        class="bg-white border border-gray-300 p-6 rounded-2xl shadow-sm text-center hover:shadow-md transition-shadow"
                    >
                        <span
                            id="enproceso-denuncias"
                            class="text-4xl font-semibold text-black"
                        >
                            {Enproceso}
                        </span>
                        <p class="text-sm text-gray-600 mt-2">
                            Denuncias en proceso
                        </p>
                    </article>

                    <article
                        class="bg-white border border-gray-300 p-6 rounded-2xl shadow-sm text-center hover:shadow-md transition-shadow"
                    >
                        <span
                            id="resuelta-denuncias"
                            class="text-4xl font-semibold text-black"
                        >
                            {resuelta}
                        </span>
                        <p class="text-sm text-gray-600 mt-2">
                            Denuncias completadas
                        </p>
                    </article>

                    <article
                        class="bg-white border border-gray-300 p-6 rounded-2xl shadow-sm text-center hover:shadow-md transition-shadow"
                    >
                        <span
                            id="resuelta-denuncias"
                            class="text-4xl font-semibold text-black"
                        >
                            {no_corresponde}
                        </span>
                        <p class="text-sm text-gray-600 mt-2">
                            Denuncias que no corresponden
                        </p>
                    </article>
                </section>

                <FiltrarDenuncia client:load />
            </div>
        </main>
    </div>
</Layout>

astro<!-- Script de protección de ruta -->
<script>
    // @ts-ignore
    import { supabase } from "../lib/supabaseClient.ts";

    const checkAuth = async () => {
        const { data } = await supabase.auth.getSession();
        const session = data?.session;

        if (!session) {
            window.location.replace("/");
            return;
        }

        document.getElementById("auth-loading")?.classList.add("hidden");
        document
            .getElementById("protected-content")
            ?.classList.remove("hidden");
    };

    checkAuth();

    supabase.auth.onAuthStateChange((_event: string, session: any) => {
        if (_event === "SIGNED_OUT" || !session) {
            window.location.replace("/");
        }
    });

    window.history.pushState(null, "", window.location.href);
    window.addEventListener("popstate", () => {
        window.history.pushState(null, "", window.location.href);
    });
</script>
<!-- Script para actualizar contadores -->
<script is:inline>
    (() => {
        const updateCards = (counts) => {
            document.getElementById("total-denuncias").textContent =
                counts.total;
            document.getElementById("pendiente-denuncias").textContent =
                counts.pendiente;
            document.getElementById("enproceso-denuncias").textContent =
                counts.enproceso;
            document.getElementById("resuelta-denuncias").textContent =
                counts.resuelta;
            document.getElementById("no_corresponde-denuncias").textContent =
                counts.no_corresponde;
        };

        window.addEventListener("denunciaDataLoaded", (event) => {
            updateCards(event.detail);
        });
    })();
</script>
